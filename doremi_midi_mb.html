<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ + micro:bit ì „ì†¡ (Web Serial)</title>

  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <!-- @tonejs/midi -->
  <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    #note {
      font-size: 64px;
      margin-top: 30px;
      font-weight: bold;
    }
    button {
      font-size: 16px;
      padding: 10px 16px;
      margin: 5px;
    }
  </style>
</head>
<body>

  <h1>ğŸ¼ MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ</h1>

  <input type="file" id="midiFile" accept=".mid,.midi" />
  <br /><br />

  <button id="connectBtn">ğŸ”Œ micro:bit ì—°ê²°</button>
  <button id="playBtn">â–¶ ì¬ìƒ</button>

  <div id="note">-</div>

  <script>
    let midiData = null;
    let synth = new Tone.PolySynth(Tone.Synth).toDestination();
    let holdTimer = null;

    // Web Serial ê´€ë ¨
    let port = null;
    let writer = null;
    let lastSentNote = null;

    const noteNames = ["ë„", "ë„#", "ë ˆ", "ë ˆ#", "ë¯¸", "íŒŒ", "íŒŒ#", "ì†”", "ì†”#", "ë¼", "ë¼#", "ì‹œ"];

    const NOTE_MAP = {
      "ë„": 0, "ë„#": 1, "ë ˆ": 2, "ë ˆ#": 3,
      "ë¯¸": 4, "íŒŒ": 5, "íŒŒ#": 6,
      "ì†”": 7, "ì†”#": 8, "ë¼": 9,
      "ë¼#": 10, "ì‹œ": 11
    };

    /* =========================
       MIDI íŒŒì¼ ë¡œë“œ
    ========================== */
    document.getElementById("midiFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const buffer = await file.arrayBuffer();
      midiData = new Midi(buffer);

      console.log("[MIDI] íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
      alert("MIDI íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
    });

    /* =========================
       micro:bit ì—°ê²° (Web Serial)
    ========================== */
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        writer = port.writable.getWriter();

        console.log("[Serial] micro:bit ì—°ê²° ì„±ê³µ");
        alert("micro:bit ì—°ê²° ì„±ê³µ");
      } catch (e) {
        console.error("[Serial] ì—°ê²° ì‹¤íŒ¨", e);
        alert("micro:bit ì—°ê²° ì‹¤íŒ¨");
      }
    });

    /* =========================
       ì¬ìƒ ë²„íŠ¼
    ========================== */
    document.getElementById("playBtn").addEventListener("click", async () => {
      if (!midiData) {
        alert("ë¨¼ì € MIDI íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");
        return;
      }

      await Tone.start();
      Tone.Transport.cancel();
      Tone.Transport.stop();

      console.log("[Player] ì¬ìƒ ì‹œì‘");
      scheduleMidi(midiData);
      Tone.Transport.start();
    });

    function scheduleMidi(midi) {
      midi.tracks.forEach(track => {
        track.notes.forEach(note => {

          // ì‚¬ìš´ë“œ ì¬ìƒ
          Tone.Transport.schedule(time => {
            synth.triggerAttackRelease(
              note.name,
              note.duration,
              time,
              note.velocity
            );
          }, note.time);

          // ìŒê³„ í‘œì‹œ + ì „ì†¡
          Tone.Transport.schedule(time => {
            showNote(note.midi);
          }, note.time);
        });
      });
    }

    function showNote(midiNumber) {
      const name = noteNames[midiNumber % 12];
      document.getElementById("note").innerText = name;

      console.log("[Note] í‘œì‹œ:", name, "(midi:", midiNumber, ")");
      sendToMicrobit(name);

      // ìŒ ìœ ì§€ (500ms)
      clearTimeout(holdTimer);
      holdTimer = setTimeout(() => {
        document.getElementById("note").innerText = "-";
        lastSentNote = null;
      }, 500);
    }

    /* =========================
       micro:bitë¡œ ìŒê³„ ì „ì†¡
    ========================== */
    async function sendToMicrobit(noteName) {
      if (!writer) {
        console.warn("[Serial] ì•„ì§ micro:bit ì—°ê²° ì•ˆ ë¨");
        return;
      }
      if (noteName === "-" || noteName === lastSentNote) return;

      lastSentNote = noteName;

      const value = NOTE_MAP[noteName];
      const text = value.toString() + "\n";
      const data = new TextEncoder().encode(text);

      // âœ… ì›¹ì—ì„œ ë³´ë‚´ëŠ” ê°’ í™•ì¸
      console.log("[Serial] ì „ì†¡ â†’", noteName, "=", value);

      try {
        await writer.write(data);
      } catch (e) {
        console.error("[Serial] ì „ì†¡ ì˜¤ë¥˜", e);
      }
    }
  </script>

</body>
</html>
