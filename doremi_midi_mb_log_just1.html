<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ + micro:bit ì „ì†¡ (Web Serial)</title>

  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <!-- @tonejs/midi -->
  <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    #note {
      font-size: 64px;
      margin-top: 20px;
      font-weight: bold;
    }
    button {
      font-size: 16px;
      padding: 10px 16px;
      margin: 5px;
      cursor: pointer;
    }
    #history {
      margin: 20px auto;
      width: 80%;
      height: 120px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
      text-align: left;
    }
  </style>
</head>

<body>

  <h1>ğŸ¼ MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ</h1>

  <input type="file" id="midiFile" accept=".mid,.midi" />
  <br /><br />

  <button id="connectBtn">ğŸ”Œ micro:bit ì—°ê²°</button>
  <button id="playBtn">â–¶ ì¬ìƒ</button>
  <button id="stopBtn">â¹ ë©ˆì¶¤</button>

  <div id="note">-</div>

  <h3>ğŸ“œ ì „ì†¡ ê¸°ë¡</h3>
  <div id="history"></div>

  <script>
    let midiData = null;
    let synth = new Tone.PolySynth(Tone.Synth).toDestination();
    let holdTimer = null;

    let port = null;
    let writer = null;
    let lastSentNote = null;

    const noteNames = ["ë„", "ë„#", "ë ˆ", "ë ˆ#", "ë¯¸", "íŒŒ", "íŒŒ#", "ì†”", "ì†”#", "ë¼", "ë¼#", "ì‹œ"];

    const NOTE_MAP = {
      "ë„": 0, "ë„#": 1, "ë ˆ": 2, "ë ˆ#": 3,
      "ë¯¸": 4, "íŒŒ": 5, "íŒŒ#": 6,
      "ì†”": 7, "ì†”#": 8, "ë¼": 9,
      "ë¼#": 10, "ì‹œ": 11
    };

    function addHistory(text) {
      const div = document.getElementById("history");
      div.innerText += text + " ";
      div.scrollTop = div.scrollHeight;
    }

    /* =========================
       MIDI íŒŒì¼ ë¡œë“œ
    ========================== */
    document.getElementById("midiFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const buffer = await file.arrayBuffer();
      midiData = new Midi(buffer);

      console.log("[MIDI] íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
      alert("MIDI íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
    });

    /* =========================
       micro:bit ì—°ê²°
    ========================== */
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();

        console.log("[Serial] micro:bit ì—°ê²° ì„±ê³µ");
        alert("micro:bit ì—°ê²° ì„±ê³µ");
      } catch (e) {
        console.error("[Serial] ì—°ê²° ì‹¤íŒ¨", e);
        alert("micro:bit ì—°ê²° ì‹¤íŒ¨");
      }
    });

    /* =========================
       ì¬ìƒ
    ========================== */
    document.getElementById("playBtn").addEventListener("click", async () => {
      if (!midiData) {
        alert("ë¨¼ì € MIDI íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");
        return;
      }

      await Tone.start();

      Tone.Transport.stop();
      Tone.Transport.cancel();
      synth.releaseAll();

      document.getElementById("history").innerText = "";

      console.log("[Player] ì¬ìƒ ì‹œì‘");

      scheduleMidi(midiData);
      Tone.Transport.start();
    });

    /* =========================
       ë©ˆì¶¤
    ========================== */
    document.getElementById("stopBtn").addEventListener("click", () => {
      Tone.Transport.stop();
      Tone.Transport.cancel();
      synth.releaseAll();

      document.getElementById("note").innerText = "-";
      lastSentNote = null;
    });

    /* =========================
       MIDI ìŠ¤ì¼€ì¤„ (â­ ìµœê³ ìŒ ì„ íƒ)
    ========================== */
    function scheduleMidi(midi) {

      // time ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°
      const groups = {};

      midi.tracks.forEach(track => {
        track.notes.forEach(note => {
          const t = note.time.toFixed(3); // ì‹œê°„ ë¬¶ê¸°
          if (!groups[t]) groups[t] = [];
          groups[t].push(note);
        });
      });

      // ê° ì‹œê°„ë§ˆë‹¤ ìµœê³ ìŒë§Œ ì„ íƒ
      Object.keys(groups).forEach(t => {
        const notes = groups[t];

        // ìµœê³ ìŒ ì°¾ê¸°
        const highest = notes.reduce((max, n) => n.midi > max.midi ? n : max);

        Tone.Transport.schedule(time => {
          synth.triggerAttackRelease(
            highest.name,
            highest.duration,
            time,
            highest.velocity
          );
        }, parseFloat(t));

        Tone.Transport.schedule(time => {
          showNote(highest.midi);
        }, parseFloat(t));
      });
    }

    function showNote(midiNumber) {
      const name = noteNames[midiNumber % 12];

      document.getElementById("note").innerText = name;
      addHistory(name);

      sendToMicrobit(name);

      clearTimeout(holdTimer);
      holdTimer = setTimeout(() => {
        document.getElementById("note").innerText = "-";
        lastSentNote = null;
      }, 500);
    }

    /* =========================
       micro:bit ì „ì†¡
    ========================== */
    async function sendToMicrobit(noteName) {
      if (!writer) return;
      if (noteName === "-" || noteName === lastSentNote) return;

      lastSentNote = noteName;

      const value = NOTE_MAP[noteName];
      const text = value.toString() + "\n";
      const data = new TextEncoder().encode(text);

      try {
        await writer.write(data);
      } catch (e) {
        console.error("[Serial] ì „ì†¡ ì˜¤ë¥˜", e);
      }
    }
  </script>

</body>
</html>
