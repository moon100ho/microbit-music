<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ + micro:bit ì „ì†¡ (Web Serial)</title>

  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    #note { font-size: 64px; margin-top: 20px; font-weight: bold; }
    button { font-size: 14px; padding: 6px 10px; margin: 4px; cursor: pointer; }
    #history {
      margin: 20px auto; width: 80%; height: 120px;
      overflow-y: auto; border: 1px solid #ccc;
      padding: 10px; font-family: monospace; text-align: left;
    }
    .modeRow { margin: 6px 0; }
    input[type="text"] { width: 200px; padding: 4px; }
  </style>
</head>

<body>

<h1>ğŸ¼ MIDI ì¬ìƒ + ìŒê³„ í‘œì‹œ</h1>

<input type="file" id="midiFile" accept=".mid,.midi" />
<br /><br />

<button id="connectBtn">ğŸ”Œ micro:bit ì—°ê²°</button>
<button id="playBtn">â–¶ ì¬ìƒ</button>
<button id="stopBtn">â¹ ë©ˆì¶¤</button>

<div id="note">-</div>

<h3>í˜„ì¬ ëª¨ë“œ: <span id="currentModeText">ê¸°ë³¸</span></h3>
<h3>ğŸ› íš¨ê³¼ ëª¨ë“œ ì„ íƒ</h3>

<div class="modeRow">
  <button onclick="setMode(0)">ê¸°ë³¸ëª¨ë“œ</button>
</div>

<div class="modeRow">
  Aíš¨ê³¼ :
  <input type="text">
  <button onclick="setMode(1)">Aíš¨ê³¼ ì ìš©</button>
</div>

<div class="modeRow">
  Bíš¨ê³¼ :
  <input type="text">
  <button onclick="setMode(2)">Bíš¨ê³¼ ì ìš©</button>
</div>

<div class="modeRow">
  Cíš¨ê³¼ :
  <input type="text">
  <button onclick="setMode(3)">Cíš¨ê³¼ ì ìš©</button>
</div>

<div class="modeRow">
  Díš¨ê³¼ :
  <input type="text">
  <button onclick="setMode(4)">Díš¨ê³¼ ì ìš©</button>
</div>

<h3>ğŸ“œ ì „ì†¡ ê¸°ë¡</h3>
<div id="history"></div>

<script>

let midiData = null;
let synth = new Tone.PolySynth(Tone.Synth).toDestination();
let port = null;
let writer = null;
let lastSentValue = null;
let currentMode = 0;

const noteNames = ["ë„","ë„#","ë ˆ","ë ˆ#","ë¯¸","íŒŒ","íŒŒ#","ì†”","ì†”#","ë¼","ë¼#","ì‹œ"];

function setMode(mode) {
  currentMode = mode;
  const modeNames = ["ê¸°ë³¸","A","B","C","D"];
  document.getElementById("currentModeText").innerText = modeNames[mode];
}

function addHistory(text) {
  const div = document.getElementById("history");
  div.innerText += text + "/";
  div.scrollTop = div.scrollHeight;
}

/* =========================
   OFF ì‹ í˜¸ ì „ì†¡ (-1)
========================= */
async function sendOffSignal() {
  if (!writer) return;

  const text = "-1\n";
  const data = new TextEncoder().encode(text);

  try {
    await writer.write(data);
  } catch (e) {
    console.error("OFF ì „ì†¡ ì˜¤ë¥˜", e);
  }

  lastSentValue = null;
}

/* =========================
   MIDI íŒŒì¼ ë¡œë“œ
========================= */
document.getElementById("midiFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const buffer = await file.arrayBuffer();
  midiData = new Midi(buffer);

  alert("MIDI íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
});

/* =========================
   micro:bit ì—°ê²°
========================= */
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
    alert("micro:bit ì—°ê²° ì„±ê³µ");
  } catch (e) {
    alert("micro:bit ì—°ê²° ì‹¤íŒ¨");
  }
});

/* =========================
   ì¬ìƒ
========================= */
document.getElementById("playBtn").addEventListener("click", async () => {
  if (!midiData) {
    alert("ë¨¼ì € MIDI íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  await Tone.start();
  Tone.Transport.stop();
  Tone.Transport.cancel();
  synth.releaseAll();

  document.getElementById("history").innerText = "";
  setMode(0);

  scheduleMidi(midiData);
  Tone.Transport.start();
});

/* =========================
   ë©ˆì¶¤ ë²„íŠ¼ â†’ -1 ì „ì†¡
========================= */
document.getElementById("stopBtn").addEventListener("click", async () => {
  Tone.Transport.stop();
  Tone.Transport.cancel();
  synth.releaseAll();
  document.getElementById("note").innerText = "-";

  await sendOffSignal();
});

/* =========================
   ê³¡ ì™„ì „ ì¢…ë£Œ ì‹œ -1 ì „ì†¡
========================= */
Tone.Transport.on("stop", async () => {
  await sendOffSignal();
});

/* =========================
   MIDI ìŠ¤ì¼€ì¤„
========================= */
function scheduleMidi(midi) {

  const groups = {};

  midi.tracks.forEach(track => {
    track.notes.forEach(note => {
      const t = note.time.toFixed(3);
      if (!groups[t]) groups[t] = [];
      groups[t].push(note);
    });
  });

  Object.keys(groups).forEach(t => {
    const notes = groups[t];
    const highest = notes.reduce((max, n) => n.midi > max.midi ? n : max);

    Tone.Transport.schedule(time => {
      synth.triggerAttackRelease(
        highest.name,
        highest.duration,
        time,
        highest.velocity
      );
    }, parseFloat(t));

    Tone.Transport.schedule(time => {
      showNote(highest.midi);
    }, parseFloat(t));
  });

  // ë§ˆì§€ë§‰ ë…¸íŠ¸ ì‹œê°„ ê³„ì‚°í•´ì„œ ìë™ ì¢…ë£Œ
  const lastTime = Math.max(...Object.keys(groups).map(t => parseFloat(t)));
  Tone.Transport.schedule(() => {
    Tone.Transport.stop();
  }, lastTime + 1);
}

function showNote(midiNumber) {
  const noteIndex = midiNumber % 12;
  document.getElementById("note").innerText = noteNames[noteIndex];
  sendToMicrobit(noteIndex);
}

/* =========================
   micro:bit ì „ì†¡
========================= */
async function sendToMicrobit(noteValue) {
  if (!writer) return;

  const combinedValue = currentMode * 100 + noteValue;

  if (combinedValue === lastSentValue) return;

  lastSentValue = combinedValue;

  const modeChars = ["","A","B","C","D"];
  const displayText =
    modeChars[currentMode] +
    noteNames[noteValue] +
    combinedValue.toString();

  addHistory(displayText);

  const text = combinedValue.toString() + "\n";
  const data = new TextEncoder().encode(text);

  try {
    await writer.write(data);
  } catch (e) {
    console.error("ì „ì†¡ ì˜¤ë¥˜", e);
  }
}

</script>

</body>
</html>